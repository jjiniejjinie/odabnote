{% extends "base.html" %}

{% block title %}ë¬¸ì œ ì¶”ê°€ - ì˜¤ë‹µë…¸íŠ¸{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“· ë¬¸ì œ ì¶”ê°€</h1>
</div>

<div class="problem-add-container">
    <form method="POST" enctype="multipart/form-data" class="problem-add-form">
        <div class="form-section">
            <h3>1. ë¬¸ì œ ì´ë¯¸ì§€</h3>
            <div class="image-upload-area" id="imageUploadArea">
                <input type="file" id="problem_image" name="problem_image" 
                       accept="image/*" required hidden onchange="previewImage(event)">
                <label for="problem_image" class="upload-label">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">
                        <p><strong>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</strong></p>
                        <p>ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                    </div>
                </label>
                <div id="imagePreview" class="image-preview" style="display: none;">
                    <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                    <button type="button" class="btn btn-secondary" onclick="resetImage()">ë‹¤ì‹œ ì„ íƒ</button>
                </div>
            </div>
            <!-- ì €ì‘ê¶Œ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€ -->
            <p class="image-notice">ğŸ’¡ ë³¸ì¸ì´ êµ¬ë§¤í•œ êµì¬ì˜ ë¬¸ì œë§Œ ë“±ë¡í•´ì£¼ì„¸ìš”</p>
        </div>

        <div class="form-section">
            <h3>2. ì €ì¥ ìœ„ì¹˜</h3>
            
            <div class="form-group">
                <label for="workbook_select">ë¬¸ì œì§‘ ì„ íƒ *</label>
                <div class="select-with-button">
                    <select id="workbook_select" required onchange="loadUnits()">
                        <option value="">-- ë¬¸ì œì§‘ ì„ íƒ --</option>
                        {% for workbook in workbooks %}
                        <option value="{{ workbook.id }}">{{ workbook.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="showCreateWorkbookModal()">+ ì¶”ê°€</button>
                </div>
            </div>

            <div class="form-group">
                <label for="unit_id">ë‹¨ì› ì„ íƒ *</label>
                <div class="select-with-button">
                    <select id="unit_id" name="unit_id" required disabled>
                        <option value="">-- ë¨¼ì € ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                    </select>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="showCreateUnitModal()" id="addUnitBtn" disabled>+ ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('home') }}" class="btn btn-secondary">ì·¨ì†Œ</a>
            <button type="submit" class="btn btn-primary">ë¬¸ì œ ì¶”ê°€</button>
        </div>
    </form>
</div>

<!-- ë¬¸ì œì§‘ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="createWorkbookModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>ë¬¸ì œì§‘ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeModal('createWorkbookModal')">&times;</button>
        </div>
        <form id="createWorkbookForm" onsubmit="return createWorkbook(event)">
            <div class="form-group">
                <label for="workbook_name">ë¬¸ì œì§‘ ì´ë¦„ *</label>
                <input type="text" id="workbook_name" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createWorkbookModal')">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ìƒì„±</button>
            </div>
        </form>
    </div>
</div>

<!-- ë‹¨ì› ì¶”ê°€ ëª¨ë‹¬ -->
<div id="createUnitModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>ë‹¨ì› ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeModal('createUnitModal')">&times;</button>
        </div>
        <form id="createUnitForm" onsubmit="return createUnit(event)">
            <div class="form-group">
                <label for="unit_name">ë‹¨ì› ì´ë¦„ *</label>
                <input type="text" id="unit_name" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createUnitModal')">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ìƒì„±</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* ì €ì‘ê¶Œ ì•ˆë‚´ ë¬¸êµ¬ ìŠ¤íƒ€ì¼ */
    .image-notice {
        font-size: 12px;
        color: #666;
        margin-top: 12px;
        margin-bottom: 0;
        padding-left: 4px;
        font-weight: 500;
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.querySelector('.upload-label').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'flex';
        }
        reader.readAsDataURL(file);
    }
}

function resetImage() {
    document.getElementById('problem_image').value = '';
    document.querySelector('.upload-label').style.display = 'flex';
    document.getElementById('imagePreview').style.display = 'none';
}

async function loadUnits() {
    const workbookId = document.getElementById('workbook_select').value;
    const unitSelect = document.getElementById('unit_id');
    const addUnitBtn = document.getElementById('addUnitBtn');
    
    if (!workbookId) {
        unitSelect.disabled = true;
        addUnitBtn.disabled = true;
        unitSelect.innerHTML = '<option value="">-- ë¨¼ì € ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš” --</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/units/by-workbook/${workbookId}`);
        const data = await response.json();
        
        unitSelect.innerHTML = '<option value="">-- ë‹¨ì› ì„ íƒ --</option>';
        data.units.forEach(unit => {
            unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
        });
        
        unitSelect.disabled = false;
        addUnitBtn.disabled = false;
    } catch (error) {
        alert('ë‹¨ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function showCreateWorkbookModal() {
    document.getElementById('createWorkbookModal').style.display = 'flex';
}

function showCreateUnitModal() {
    const workbookId = document.getElementById('workbook_select').value;
    if (!workbookId) {
        alert('ë¨¼ì € ë¬¸ì œì§‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    document.getElementById('createUnitModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

async function createWorkbook(event) {
    event.preventDefault();
    const name = document.getElementById('workbook_name').value;
    
    const formData = new FormData();
    formData.append('name', name);
    
    try {
        const response = await fetch('/workbooks/create', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('ë¬¸ì œì§‘ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    
    return false;
}

async function createUnit(event) {
    event.preventDefault();
    const workbookId = document.getElementById('workbook_select').value;
    const name = document.getElementById('unit_name').value;
    
    if (!workbookId) {
        alert('ë¨¼ì € ë¬¸ì œì§‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return false;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    
    try {
        const response = await fetch(`/workbooks/${workbookId}/units/create`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            closeModal('createUnitModal');
            await loadUnits();
            document.getElementById('unit_name').value = '';
        } else {
            alert('ë‹¨ì› ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    
    return false;
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
const uploadArea = document.getElementById('imageUploadArea');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => {
        uploadArea.classList.add('drag-over');
    });
});

['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => {
        uploadArea.classList.remove('drag-over');
    });
});

uploadArea.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('problem_image').files = files;
        previewImage({ target: { files: files } });
    }
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}
