{% extends "base.html" %}

{% block title %}ë¬¸ì œ {{ problem.problem_number }} - ì˜¤ë‹µë…¸íŠ¸{% endblock %}

{% block extra_css %}
<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('workbook_list') }}">ë¬¸ì œì§‘</a>
    <span class="separator">â€º</span>
    <a href="{{ url_for('unit_list', workbook_id=problem.unit.workbook_id) }}">{{ problem.unit.workbook.name }}</a>
    <span class="separator">â€º</span>
    <a href="{{ url_for('problem_list', unit_id=problem.unit_id) }}">{{ problem.unit.name }}</a>
    <span class="separator">â€º</span>
    <span>ë¬¸ì œ {{ problem.problem_number }}</span>
</div>

<div class="page-header">
    <h1>ğŸ“ ë¬¸ì œ {{ problem.problem_number }}</h1>
</div>

<div class="problem-detail-container">
    <!-- ë¬¸ì œ ì„¹ì…˜ -->
    <div class="detail-section">
        <div class="section-header">
            <h2>ë¬¸ì œ</h2>
            {% if not problem.is_text_extracted %}
            <button class="btn btn-primary" onclick="extractText()">
                <span id="extractBtn">ğŸ” í…ìŠ¤íŠ¸ ì¶”ì¶œí•˜ê¸°</span>
                <span id="extractLoading" style="display: none;">â³ ì¶”ì¶œ ì¤‘...</span>
            </button>
            {% endif %}
        </div>
        
        <div class="problem-image-container">
            {% if problem.problem_image_path %}
            <img src="{{ problem.problem_image_path | cloudinary_url }}" alt="ë¬¸ì œ ì´ë¯¸ì§€" class="problem-image">
            {% endif %}
        </div>
        
        <!-- ì¶”ì¶œëœ í…ìŠ¤íŠ¸ í¸ì§‘ ì˜ì—­ -->
        <div id="extractedTextArea" style="display: none;">
            <div class="form-group">
                <label for="extractedText">ì¶”ì¶œëœ í…ìŠ¤íŠ¸ (Markdown)</label>
                <!-- KaTeX ë Œë”ë§ (ì½ê¸° ì „ìš©) -->
                <div id="extractedTextDisplay" 
                     class="text-display" 
                     style="min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white; margin-bottom: 10px; white-space: pre-wrap;">
                </div>
            </div>
            <div class="text-actions">
                <button class="btn btn-secondary" onclick="closeExtractedText()">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="saveExtractedText()">ì €ì¥</button>
            </div>
        </div>
        
        {% if problem.is_text_extracted and problem.problem_text %}
        <div class="extracted-text">
            <h3>ì¶”ì¶œëœ í…ìŠ¤íŠ¸ (Markdown)</h3>
            <div class="text-display" id="problemText">
                {{ problem.problem_text }}
            </div>
            <div class="text-actions">
                <button class="btn btn-secondary btn-sm" onclick="editProblemText()">âœï¸ ìˆ˜ì •</button>
                <button class="btn btn-secondary btn-sm" onclick="copyText('problemText')">ğŸ“‹ ë³µì‚¬</button>
            </div>
            
            <!-- ìˆ˜ì • ëª¨ë“œ -->
            <div id="editProblemTextArea" style="display: none;">
                <!-- ì›ë¬¸ í¸ì§‘ textarea -->
                <textarea id="problemTextRaw" 
                          class="form-control" 
                          style="min-height: 200px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; margin-bottom: 10px;">{{ problem.problem_text }}</textarea>
                
                <!-- ë¯¸ë¦¬ë³´ê¸° (KaTeX ë Œë”ë§) -->
                <div style="margin-bottom: 10px;">
                    <strong>ë¯¸ë¦¬ë³´ê¸°:</strong>
                </div>
                <div id="problemTextPreview" 
                     class="text-display" 
                     style="padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; min-height: 200px;">
                </div>
                
                <div class="text-actions">
                    <button class="btn btn-secondary" onclick="cancelEditProblemText()">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="saveProblemText()">ì €ì¥</button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- ì •ë‹µ ì„¹ì…˜ -->
    <div class="detail-section">
        <div class="section-header">
            <h2>ì •ë‹µ</h2>
            {% if not problem.has_answer %}
            <button class="btn btn-primary" onclick="showAnswerModal()">â• ì •ë‹µ ì¶”ê°€</button>
            {% endif %}
        </div>
        
        {% if problem.has_answer %}
            {% if problem.answer_image_path %}
            <div class="answer-image-container">
                <img src="{{ problem.answer_image_path | cloudinary_url }}" alt="ì •ë‹µ ì´ë¯¸ì§€" class="answer-image">
            </div>
            {% endif %}
            
            {% if problem.answer_text %}
            <div class="extracted-text">
                <h3>ì •ë‹µ (Markdown)</h3>
                <div class="text-display" id="answerText">
                    {{ problem.answer_text }}
                </div>
                <div class="text-actions">
                    <button class="btn btn-secondary btn-sm" onclick="editAnswerText()">âœï¸ ìˆ˜ì •</button>
                    <button class="btn btn-secondary btn-sm" onclick="copyText('answerText')">ğŸ“‹ ë³µì‚¬</button>
                </div>
                
                <!-- ìˆ˜ì • ëª¨ë“œ -->
                <div id="editAnswerTextArea" style="display: none;">
                    <textarea id="answerTextEdit" rows="10" class="form-control">{{ problem.answer_text }}</textarea>
                    <div class="text-actions">
                        <button class="btn btn-secondary" onclick="cancelEditAnswerText()">ì·¨ì†Œ</button>
                        <button class="btn btn-primary" onclick="saveAnswerText()">ì €ì¥</button>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="no-answer">
                <p>ì •ë‹µì´ ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- ì •ë‹µ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="answerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ì •ë‹µ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeModal('answerModal')">&times;</button>
        </div>
        
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="switchTab('image')">ì´ë¯¸ì§€ë¡œ ì¶”ê°€</button>
            <button class="tab-btn" onclick="switchTab('text')">í…ìŠ¤íŠ¸ë¡œ ì¶”ê°€</button>
        </div>
        
        <form method="POST" action="{{ url_for('problem_add_answer', problem_id=problem.id) }}" 
              enctype="multipart/form-data" id="answerForm">
            
            <!-- ì´ë¯¸ì§€ íƒ­ -->
            <div id="imageTab" class="tab-content active">
                <input type="hidden" name="answer_type" value="image">
                <div class="form-group">
                    <label for="answer_image">ì •ë‹µ ì´ë¯¸ì§€</label>
                    <input type="file" id="answer_image" name="answer_image" accept="image/*" class="form-control">
                </div>
            </div>
            
            <!-- í…ìŠ¤íŠ¸ íƒ­ -->
            <div id="textTab" class="tab-content">
                <input type="hidden" name="answer_type" value="text">
                <div class="form-group">
                    <label for="answer_text">ì •ë‹µ í…ìŠ¤íŠ¸ (Markdown)</label>
                    <textarea id="answer_text" name="answer_text" rows="10" class="form-control" 
                              placeholder="Markdown í˜•ì‹ìœ¼ë¡œ ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('answerModal')">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let extractedOriginalText = ''; // ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥ìš© ì „ì—­ ë³€ìˆ˜

async function extractText() {
    const btnText = document.getElementById('extractBtn');
    const btnLoading = document.getElementById('extractLoading');
    
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    
    try {
        const response = await fetch(`/problems/{{ problem.id }}/extract`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ì›ë³¸ í…ìŠ¤íŠ¸ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            extractedOriginalText = data.text;
            
            // í‘œì‹œ ì˜ì—­ì— í…ìŠ¤íŠ¸ ì„¤ì •
            const displayDiv = document.getElementById('extractedTextDisplay');
            displayDiv.textContent = data.text;
            
            // KaTeX ë Œë”ë§
            renderMathInElement(displayDiv, {
                delimiters: [
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '$$', right: '$$', display: true}
                ],
                throwOnError: false
            });
            
            document.getElementById('extractedTextArea').style.display = 'block';
            
            // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.querySelector('.section-header .btn-primary').style.display = 'none';
            
            alert('í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');
        } else {
            alert('í…ìŠ¤íŠ¸ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
    }
}

function closeExtractedText() {
    document.getElementById('extractedTextArea').style.display = 'none';
    document.querySelector('.section-header .btn-primary').style.display = 'inline-block';
}

async function saveExtractedText() {
    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ëœ ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
    const text = extractedOriginalText;
    
    if (!text) {
        alert('ì €ì¥í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        const response = await fetch(`/problems/{{ problem.id }}/text/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text: text })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.reload();
        } else {
            alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
    }
}

function editProblemText() {
    const textarea = document.getElementById('problemTextRaw');
    const preview = document.getElementById('problemTextPreview');
    
    // ì´ˆê¸° ë Œë”ë§
    renderProblemPreview();
    
    // ì‹¤ì‹œê°„ ë Œë”ë§
    textarea.addEventListener('input', renderProblemPreview);
    
    document.getElementById('problemText').style.display = 'none';
    document.getElementById('editProblemTextArea').style.display = 'block';
}

function renderProblemPreview() {
    const textarea = document.getElementById('problemTextRaw');
    const preview = document.getElementById('problemTextPreview');
    
    // í…ìŠ¤íŠ¸ë¥¼ previewì— í‘œì‹œ
    preview.textContent = textarea.value;
    
    // KaTeX ë Œë”ë§
    renderMathInElement(preview, {
        delimiters: [
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '$', right: '$', display: false},
            {left: '$$', right: '$$', display: true}
        ],
        throwOnError: false
    });
}

function cancelEditProblemText() {
    document.getElementById('problemText').style.display = 'block';
    document.getElementById('editProblemTextArea').style.display = 'none';
}

async function saveProblemText() {
    // textarea ì›ë¬¸ë§Œ ì €ì¥!
    const textarea = document.getElementById('problemTextRaw');
    const text = textarea.value;
    
    try {
        const response = await fetch(`/problems/{{ problem.id }}/text/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text: text })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.reload();
        } else {
            alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
    }
}

function editAnswerText() {
    document.getElementById('answerText').style.display = 'none';
    document.getElementById('editAnswerTextArea').style.display = 'block';
}

function cancelEditAnswerText() {
    document.getElementById('answerText').style.display = 'block';
    document.getElementById('editAnswerTextArea').style.display = 'none';
}

function saveAnswerText() {
    const newText = document.getElementById('answerTextEdit').value;
    // TODO: AJAXë¡œ ì„œë²„ì— ì €ì¥
    alert('ì €ì¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

function copyText(elementId) {
    const text = document.getElementById(elementId).innerText;
    navigator.clipboard.writeText(text).then(() => {
        alert('í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
}

function showAnswerModal() {
    document.getElementById('answerModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function switchTab(tab) {
    // íƒ­ ë²„íŠ¼ í™œì„±í™”
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // íƒ­ ì»¨í…ì¸  ì „í™˜
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    if (tab === 'image') {
        document.getElementById('imageTab').classList.add('active');
        document.querySelector('input[name="answer_type"]').value = 'image';
    } else {
        document.getElementById('textTab').classList.add('active');
        document.querySelector('input[name="answer_type"]').value = 'text';
    }
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// KaTeX ìë™ ë Œë”ë§
document.addEventListener('DOMContentLoaded', function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '$', right: '$', display: false},
            {left: '$$', right: '$$', display: true}
        ],
        throwOnError: false
    });
});
</script>

<!-- KaTeX JS -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
{% endblock %}
